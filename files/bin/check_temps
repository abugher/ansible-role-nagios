#!/bin/bash

ret=0
warning=50
critical=60

function main() {
  cd /sys/class/thermal/

  unset zones
  zones=()
  zone_indices=()

  for zone in thermal_zone*; do
    i="$(sed 's/^thermal_zone//' <<< "${zone}")"
    zones["${i}"]=''
    zone_indices+=( "${i}" )
  done

  for ti in {1..10}; do
    sleep 1
  #  printf '.' >&2
    for zi in "${zone_indices[@]}"; do
      zone="thermal_zone${zi}"
      zones["${zi}"]="${zones[${zi}]} $(cat "${zone}/temp")"
    done
  done
  #printf '\n' >&2

  for zi in "${zone_indices[@]}"; do
    read -a temps <<< "${zones[${zi}]}"
    average=0
    for temp_raw in "${temps[@]}"; do
      average=$(( average + temp_raw ))
    done
    average="$(bc <<< "scale=0; ${average} / ${#temps[@]} / 1000")"
    if test "${average}" -gt "${critical}"; then critical; fi
    if test "${average}" -gt "${warning}"; then warning; fi
    printf 'Zone %s:  %sÂ°C;  ' "${zi}" "${average}"
  done
  printf '\n'

  return "${ret}"
}


function critical() {
  ret=2
}


function warning() {
  if test 2 = "${ret}"; then
    return 0
  else
    ret=1
  fi
}


main
